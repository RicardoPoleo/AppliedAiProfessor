<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Math 201 Class</title>
</head>
<body>
<h1>Student's view: Math 201</h1>
<div id="statusMessage">Please wait before the class begins...</div>
<audio id="audioPlayer" controls style="display: none;"></audio>
<br>
<input type="text" id="studentNameInput" placeholder="Enter your name">
<br>
<input type="text" id="questionInput" placeholder="Ask a question..." style="display: none;">
<button onclick="submitQuestion()" style="display: none;">Submit Question</button>
<div id="responses"></div>
<div id="timer">00:00</div>


<script src="https://cdn.socket.io/4.0.1/socket.io.min.js"></script>
<script>
    var socket = io();
    var statusMessage = document.getElementById('statusMessage');
    var audioPlayer = document.getElementById('audioPlayer');
    var studentNameInput = document.getElementById('studentNameInput');
    var questionInput = document.getElementById('questionInput');
    var submitButton = document.querySelector('button');
    var timerElement = document.getElementById('timer');
    var timerInterval;

    // Handle class start event
    socket.on('start_class', function (data) {
        statusMessage.style.display = 'none';
        audioPlayer.style.display = 'block';
        questionInput.style.display = 'inline';
        submitButton.style.display = 'inline';
    });

    function playAudio(filename) {
        audioPlayer.src = '/audio/' + filename;
        audioPlayer.play();
        startTimer(60); // Assuming each chunk is 60 seconds
        audioPlayer.onended = function () {
            clearInterval(timerInterval);
            socket.emit('audio_chunk_done');
        };
    }

    function startTimer(duration) {
        var timer = duration, minutes, seconds;
        timerInterval = setInterval(function () {
            minutes = parseInt(timer / 60, 10);
            seconds = parseInt(timer % 60, 10);

            minutes = minutes < 10 ? "0" + minutes : minutes;
            seconds = seconds < 10 ? "0" + seconds : seconds;

            timerElement.textContent = minutes + ":" + seconds;

            if (--timer < 0) {
                clearInterval(timerInterval);
            }
        }, 1000);
    }

    socket.on('next_audio_chunk', function (data) {
        playAudio(data.audioFile);
    });

    function submitQuestion() {
        const question = questionInput.value.trim();
        const studentName = studentNameInput.value.trim();
        if (studentName === "" || question === "") {
            alert("Please enter both your name and question.");
            return;
        }
        socket.emit('submit_question', {question: question, name: studentName});
    }

    socket.on('receive_response', function (data) {
        var responsesDiv = document.getElementById('responses');
        var responseElem = document.createElement('p');
        responseElem.textContent = `Q: ${data.question} - A: ${data.response}`;
        responsesDiv.appendChild(responseElem);
    });


    socket.on('class_ended', function () {
        alert("The class has ended.");
        statusMessage.style.display = 'block';
        statusMessage.textContent = "The class has ended.";
        audioPlayer.style.display = 'none';
        questionInput.style.display = 'none';
        submitButton.style.display = 'none';
    });

</script>
</body>
</html>